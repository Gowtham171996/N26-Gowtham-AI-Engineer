name: RAG Backend CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*' # Trigger build/push when a version tag (e.g., v1.0.0) is pushed
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allows manual trigger for testing

env:
  # Define static Docker Image settings once
  DOCKER_IMAGE_NAME: gowthambc/n26rag

jobs:
  # 1. Code Quality Stage (Linting & Static Analysis)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11 with Caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install pre-commit and dependencies
        run: |
          # Install all dependencies including dev tools for comprehensive checks
          pip install -r requirements.txt pre-commit

      - name: Run Pre-Commit Checks (Flake8, Bandit, MyPy, Black)
        run: pre-commit run --all-files

  # 2. Dedicated Build Stage (Builds image once and loads it for subsequent jobs)
  build_image:
    runs-on: ubuntu-latest
    needs: [lint]
    # CRITICAL FIX: Define output to pass the dynamically generated tag to other jobs
    outputs:
      ci_tag: ${{ steps.set_tag.outputs.CI_BUILD_TAG }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # FIX: Calculate the CI tag in a RUN step where the 'env' context is guaranteed to be available.
      - name: Calculate CI Build Tag
        id: set_tag
        run: echo "CI_BUILD_TAG=${{ env.DOCKER_IMAGE_NAME }}:ci-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and Load Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.n26rag
          # Use the calculated tag from the previous step
          tags: ${{ steps.set_tag.outputs.CI_BUILD_TAG }}
          load: true # Load into the runner's Docker daemon for the next job

  # 3. Test Stage (Uses the image built in the previous job)
  api_tests:
    runs-on: ubuntu-latest
    needs: [build_image] # Depends on successful image build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Runner Setup for Pytest Execution ---

      - name: Set up Python 3.11 with Caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install testing dependencies on runner
        run: |
          pip install -r requirements.txt pytest requests

      # Start the full RAG stack using Docker Compose
      - name: Start Full RAG Stack (Docker Compose)
        run: |
          # Use the tag passed as an output from the build_image job
          echo "Starting stack using image tag: ${{ needs.build_image.outputs.ci_tag }}"
          DOCKER_IMAGE_NAME_OVERRIDE=${{ needs.build_image.outputs.ci_tag }} docker compose -f n26rag-compose.yml up -d

      # --- Wait and Test Execution ---

      # NEW STEP: Polls the service until ready, capping the wait at 90 seconds.
      - name: Wait for API Service Readiness (90s Timeout)
        run: python ci_wait.py

      - name: Run Comprehensive API Tests (Pytest)
        run: |
          echo "Running Comprehensive API Tests (using Pytest)..."
          pytest tests/test_api.py

      # --- Teardown ---

      - name: Teardown Docker Compose
        if: always()
        run: |
          docker compose -f n26rag-compose.yml down

  # 4. Docker Image Push Stage (Only runs on push/tag and if tests pass)
  push_image:
    runs-on: ubuntu-latest
    needs: [api_tests] # Only build/push if all tests pass
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract Docker metadata (tags and labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha
            type=semver,pattern={{version}}
            type=raw,value=v1.0 # Static tag for manual consistency

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.n26rag
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
