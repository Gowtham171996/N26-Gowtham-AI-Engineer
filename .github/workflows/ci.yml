name: RAG Backend CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allows manual trigger for testing

env:
  # Define Docker Image settings once
  DOCKER_IMAGE_NAME: gowthambc/n26rag

jobs:
  # 1. Code Linting Stage (Python Static Analysis) - Linting temporarily disabled
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Removed cache: 'pip' to prevent 'pip cache dir' failure with act
          # cache: 'pip' 

      - name: Install dependencies and linters
        run: |
          # Use a minimal install for linting efficiency if possible
          pip install -r requirements.txt
          pip install flake8

      # - name: Run Flake8 Linting # TEMPORARILY DISABLED AS REQUESTED
      #   run: |
      #     echo "Running flake8 linting..."
      #     flake8 . --max-line-length=120 --exclude=venv,dist,.git,.github,docs,tests
  
  # 2. Test Stage (Combines Smoke and API Tests)
  api_tests:
    runs-on: ubuntu-latest
    needs: [lint] # Depends on linting passing
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Removed cache: 'pip' to prevent 'pip cache dir' failure with act
          # cache: 'pip' 

      - name: Install dependencies and testing tools
        run: |
          pip install -r requirements.txt
          pip install pytest requests

      - name: Start FastAPI Server in Background
        # FIX: Force inline execution by relying solely on bash -c command in a single line,
        # and removing the explicit 'shell: bash' which seems to cause the temp file path error in act.
        run: bash -c "python api.py & echo 'API_PID=$!' >> $GITHUB_ENV"
        
      - name: Wait for API Server to be Ready (Robust Polling)
        run: |
          # Poll the healthcheck endpoint for up to 30 seconds
          bash -c 'for i in $(seq 1 30); do 
            if curl --fail http://localhost:8000/healthcheck 2>/dev/null; then 
              echo "API is ready after $i seconds."
              exit 0
            fi
            echo "Waiting for API... ($i/30)"
            sleep 1
          done
          echo "API failed to start after 30 seconds"
          exit 1'
          
      - name: Run Smoke Tests (Health Check & Root Dashboard)
        run: |
          echo "Checking http://localhost:8000/healthcheck endpoint..."
          curl --fail http://localhost:8000/healthcheck
          
          echo "Checking root endpoint for RAG dashboard content..."
          # Check for a unique string on the dashboard to ensure the UI is served
          curl -s -f http://localhost:8000/ | grep -q "RAG Service Health & Ingestion"

      - name: Run Comprehensive API Tests (Pytest)
        run: |
          echo "Running Comprehensive API Tests (using Pytest)..."
          # 'tests/test_api.py' is now present and ready to run.
          pytest tests/test_api.py

      - name: Stop FastAPI Server
        if: always() # Ensure cleanup runs even on test failure
        # FIX: Force inline execution. Removed shell: bash.
        run: |
          if [ -n "${{ env.API_PID }}" ]; then
            kill ${{ env.API_PID }} || true
          fi

  # 3. Docker Image Build and Push Stage
  build_and_push_image:
    runs-on: ubuntu-latest
    needs: [api_tests] # Only build/push if all tests pass
    if: github.event_name == 'push' # Only trigger this job on 'push' events
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Extract Docker metadata (tags and labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha
            type=raw,value=v1.0 # Static tag from your comment, ensure consistency

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # PUSH IS SET TO FALSE AS REQUESTED
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
