name: RAG Backend CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
    tags: 
      - 'v*' # Trigger build/push when a version tag (e.g., v1.0.0) is pushed
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allows manual trigger for testing

env:
  # Define Docker Image settings once
  DOCKER_IMAGE_NAME: gowthambc/n26rag

jobs:
  # 1. Code Linting Stage (Python Static Analysis)
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11 with Caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # IMPROVEMENT 1: Enable dependency caching for faster setup
          cache: 'pip' 

      - name: Install dependencies and linters
        run: |
          pip install -r requirements.txt
          pip install flake8

      # - name: Run Flake8 Linting # TEMPORARILY DISABLED AS REQUESTED (Uncomment when ready)
      #   run: |
      #     echo "Running flake8 linting..."
      #     flake8 . --max-line-length=120 --exclude=venv,dist,.git,.github,docs,tests
  
  # 2. Test Stage (Combines Smoke and API Tests)
  api_tests:
    runs-on: ubuntu-latest
    needs: [lint] # Depends on linting passing
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Docker Compose Setup and Startup ---
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # Build the application image locally so Docker Compose can reference it
      - name: Build Application Image Locally
        run: |
          # Use the environment variable for the image name and tag it with 'latest'
          DOCKER_IMAGE_TAG=${{ env.DOCKER_IMAGE_NAME }}:v2.0
          echo "Building image $DOCKER_IMAGE_TAG locally..."
          docker build --tag $DOCKER_IMAGE_TAG -f Dockerfile.n26rag .

      # Start the full RAG stack using Docker Compose and wait for all services to be healthy
      - name: Start Full RAG Stack (Docker Compose)
        run: |
          # The --wait flag pauses execution until the containers are healthy/ready
          # Assuming the docker compose file is named 'n26rag-compose.yml'
          docker compose -f n26rag-compose.yml up -d --wait

      # --- Runner Setup for Pytest Execution ---
      
      - name: Set up Python 3.11 with Caching
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip' 

      - name: Install testing tools on runner
        run: |
          # Install pytest and requests on the runner to hit the Dockerized API
          pip install pytest requests
          
      # --- Test Execution ---

      - name: Run Smoke Tests (Health Check & Root Dashboard)
        run: |
          echo "Checking http://localhost:8000/healthcheck endpoint..."
          # Curl the API container on the exposed port
          curl --fail http://localhost:8000/healthcheck
          
          echo "Checking root endpoint for RAG dashboard content..."
          curl -s -f http://localhost:8000/ | grep -q "RAG Service Health & Ingestion"

      - name: Run Comprehensive API Tests (Pytest)
        run: |
          echo "Running Comprehensive API Tests (using Pytest)..."
          pytest tests/test_api.py
          
      # --- Teardown ---
      
      # Crucial: Always run the teardown to clean up the runner environment
      - name: Teardown Docker Compose
        if: always()
        run: |
          docker compose -f n26rag-compose.yml down

  # 3. Docker Image Build and Push Stage
  build_and_push_image:
    runs-on: ubuntu-latest
    needs: [api_tests] # Only build/push if all tests pass
    # Only trigger this job on 'push' events or if a tag is pushed
    if: github.event_name == 'push' || startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Extract Docker metadata (tags and labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha
            # IMPROVEMENT 3: Auto-tag based on Git tag (e.g., v1.2.3)
            type=semver,pattern={{version}} 
            type=raw,value=v1.0 # Static tag for manual consistency

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # PUSH IS SET TO FALSE AS REQUESTED in the original file
          push: false 
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
